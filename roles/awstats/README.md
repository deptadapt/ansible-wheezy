# A role for awstats

## Overview
This role installs and configures the Debian package for awstats. It assumes
that the apache2 package has already been installed by another role.

Instead of configuring awstats as a CGI application, reports are generated
as static HTML files by a cron job. These files are made accessible by an
Apache 2 VirtualHost that is protected by HTTP basic authentication. By default
the awstats site is only accessible over HTTPS. If an SSL certificate and key pair
is not provided the snakeoil certificate generated by the ssl-cert Debian package
will be used.

The Debian package for awstats includes two Debian specific scripts located in
*/usr/share/awstats/tools*. *update.sh* updates the statistics database for every site
that has a configuration file in */etc/awstats*. *buildreports.sh* generated static HTML
reports for each config file in */etc/awstats*. 

The Debian package for awstats also adds two cron jobs to the system in
/etc/cron.d/awstats.  The first job runs *update.sh* every ten minutes, the second job
runs *buildreports.sh* at 3:10. Debian has both of these jobs run by **www-data**, but this
role creates a system user **awstats** to run the update.sh cron job.

### The awstats system user
The reason for running the *update.sh* script as the user **awstats** is that this script
needs access to the apache log files in /var/log/apache2. By default these files are
owned by **root**:**adm** with permissions 640. Because **www-data** is not a member of 
the **adm** group it cannot read the logs and fails. One solution is to make the log permissions 644 and readable by anyone. The solution used by this role is to create the **awstats** user as a member of the **adm** group. **www-data** is then added to the
**awstats** group. Therefore the **awstats** user is able to read the Apache logs while
updating the stats database, and the **www-data** user is able to read the stats database,
and Apache (running as www-data) can access the static HTML files created by *buildreports.sh* The documentation for the awstats package in */usr/share/doc/awstats/README.Debian.gz* has more information.

## Variables
This role uses several default variables. The most important are:
### awstats_server_name
Defaults to the value of *ansible_fqdn*. This variable is used for the ServerName
directive in the Apache Virtual Host configuration for the awstats site.
### awstats_htpasswd
The awstats site is protected with HTTP basic authentication. The user name is
'awstats', this is the password. By default the password lookup plugin is used,
with the password stored relative to the inventory file in "passwords/*ansible_fqdn*/awstats_htpasswd
### awstats_cron_update
The cron string used for the update.sh cron job described above. Defaults to 
"*/10 * * * *" which is the default provided by the Debian package.
### awstats_cron_reports
The cron string used for the buildreports.sh cron job described above. Defaults
to "10 03 * * *" which is the default provided by the Debian package.
### awstats_ssl_cert
Path to a local file containing an SSL certificate suitable for use with Apache. If
not provided, the snakeoil SSL certificate generated by the ssl-cert Debian package
will be used.
### awstats_ssl_key
Path to a local file containing an SSL key suitable for use with Apache. If
not provided, the snakeoil SSL key generated by the ssl-cert Debian package
will be used.
### Many more awstats options
awstats has many configuration options. Some of them can be overridden. This role
uses the file */etc/awstats/awstats.conf.local* for system-wide configuration. See
the comments in *awstats/defaults/main.yml* for more information.

## Links
- [awstats configuration directives](http://awstats.sourceforge.net/docs/awstats_config.html)
- [awstats for Wheezy on packages.debian.org](https://packages.debian.org/wheezy/awstats)

