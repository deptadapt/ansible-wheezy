---
# This role is for the primary email server
# Created by Jeremy McNaughton 2013-08-26
#
# This will install and configure Postfix, Dovecot, and a bunch of related
# tools. 

# This task instructs debconf not to configure Postfix.
# The playbook will supply the necessary Postfix configuration,
# and we don't want debconf to interfere with this, including future
# upgrades of the package.
- name: preseed Postfix for "No configuration"
  shell: echo "postfix postfix/main_mailer_type select No configuration" | debconf-set-selections 

# This task commented out for testing purposes (too slow)
# - name: Make sure APT is up to date
#   apt: update_cache=yes upgrade=yes

# This task demonstrates how to install everything in one go using
# the with_items keyword.
#
# For now I've got it commented out as I am doing prep and clean-up tasks
# for some of these packages.
#
# Also note: PostgreSQL should perhaps be in its own role, with this role
# depending on it.
#
- name: Install Postfix, Dovecot
  apt: pkg={{ item }} state=latest
  with_items:
    - postfix
    - postfix-pgsql
    - dovecot-core
    - dovecot-imapd
    - dovecot-pgsql
    - dovecot-sieve
    - dovecot-managesieved
    - python-crypto
    - vmm
  notify:
    - Add doveauth group
    - Add doveauth user
    - Add dovemail group
    - Create /srv/mail directory
    - Create /srv/mail subdirectory contents
    - Configure authentication for mailsys in pg_hba.conf
    - Create temp directory for vmm script
    - Copy vmm PostgreSQL database configuration script
    - Copy vmm tables
    - Copy vmm permission script
    - Execute vmm database config script
    - Start Postfix
    - Start Dovecot

- name: Copy /etc/postfix/main.cf
  template: src=postfix/main.cf.j2 dest=/etc/postfix/main.cf owner=root group=root mode=0644
  notify:
    - Reload Postfix config

- name: Copy /etc/postfix/master.cf.j2 template
  template: src=postfix/master.cf.j2 dest=/etc/postfix/master.cf owner=root group=root mode=0644
  notify:
    - Reload Postfix config

- name: Copy /etc/dovecot/dovecot.conf
  copy: src=dovecot/dovecot.conf dest=/etc/dovecot/dovecot.conf owner=root group=root mode=0644
  notify:
    - Reload Dovecot config

- name: Copy /etc/dovecot/local.conf j2 template
  template: src=dovecot/local.conf.j2 dest=/etc/dovecot/local.conf owner=root group=root mode=0644
  notify:
    - Reload Dovecot config

- name: Copy /etc/dovecot/dovecot-dict-sql.conf.ext.j2 template
  template: src=dovecot/dovecot-dict-sql.conf.ext.j2 dest=/etc/dovecot/dovecot-dict-sql.conf.ext owner=root group=dovecot mode=0640
  notify:
    - Reload Dovecot config

- name: Copy /etc/dovecot/dovecot-sql.conf.ext.j2 template
  template: src=dovecot/dovecot-sql.conf.ext.j2 dest=/etc/dovecot/dovecot-sql.conf.ext owner=root group=dovecot mode=0600
  notify:
    - Reload Dovecot config

- name: Create directory for Postfix PostgreSQL config files.
  file: dest=/etc/postfix/pgsql state=directory owner=root group=postfix mode=0750

- name: Copy /etc/postfix/pgsql-*.cf j2 templates
  template: src=postfix/{{ item }}.j2 dest=/etc/postfix/pgsql/{{ item }} owner=root group=postfix mode=0640
  with_items:
    - pgsql-relocated_maps.cf
    - pgsql-smtpd_sender_login_maps.cf
    - pgsql-transport_maps.cf
    - pgsql-virtual_alias_maps.cf
    - pgsql-virtual_gid_maps.cf
    - pgsql-virtual_mailbox_domains.cf
    - pgsql-virtual_mailbox_maps.cf
    - pgsql-virtual_uid_maps.cf
  notify:
    - Reload Postfix config

- name: Copy /etc/aliases j2 template
  template: src=postfix/aliases dest=/etc/aliases owner=root group=root mode=0644
  notify:
    - Generate /etc/aliases
    - Reload Postfix config

- name: Copy /etc/vmm/vmm.cfg
  copy: src=vmm/vmm.cfg dest=/etc/vmm/vmm.cfg owner=root group=vmm mode=0640

- name: Copy /etc/vmm/vmm-db.cfg.j2 template
  template: src=vmm/vmm-db.cfg.j2 dest=/etc/vmm/vmm-db.cfg owner=root group=vmm mode=0640
